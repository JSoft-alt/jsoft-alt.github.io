<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shift Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .slot-card { min-height: 110px; transition: background 0.2s; }
        .slot-card:hover { background-color: #f1f5f9; }
        .skipped { opacity: 0.5; background-color: #f8fafc !important; }
        .gender-m { color: #3b82f6; }
        .gender-f { color: #f472b6; }
        .is-driver { color: #10b981; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-md">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight text-slate-800">Smart Shift Scheduler</h1>
                    <p class="text-slate-500 text-sm italic">Automated Rostering | 100% Coverage Mode</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="exportBtn" class="hidden bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 px-6 py-3 rounded-xl font-bold shadow-sm transition-transform active:scale-95 flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 10 0 1-2 2H5a2 2 10 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    Export Text
                </button>
                <button id="generateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95 flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Generate Schedule
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Configuration Sidebar -->
            <aside class="space-y-6">
                <div class="card p-6">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6 border-b pb-2">Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-slate-700">Total Duration (Days)</label>
                            <input type="number" id="daysInput" value="4" min="1" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-slate-700">Start on Day</label>
                            <select id="startDayInput" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none cursor-pointer"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-slate-700">Start Time Slot</label>
                            <select id="startTimeInput" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none cursor-pointer"></select>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 border-b pb-2">Personnel IDs</h2>
                    <textarea id="peopleInput" rows="5" class="w-full p-3 text-sm bg-slate-50 border border-slate-200 rounded-lg outline-none resize-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter IDs separated by commas...">1,2,3,4,5,6,8,9,10,11,14,15,16,19,20,23,24,25</textarea>
                    <div class="mt-3 space-y-1 text-[10px] text-slate-400">
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> 19-25: Male</div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-pink-400"></span> Others: Female</div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> D: Driver</div>
                    </div>
                </div>
            </aside>

            <!-- Results Main View -->
            <main id="scheduleContainer" class="lg:col-span-3 space-y-6 text-slate-400 text-center py-24 border-2 border-dashed border-slate-200 rounded-3xl bg-white shadow-inner">
                <div class="flex flex-col items-center gap-2">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="opacity-20"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                    <p class="font-medium">Configure settings and click "Generate Schedule"</p>
                </div>
            </main>
        </div>
    </div>

    <script>
        const TIME_SLOTS = [
            { label: "00:00-03:00", value: "0-3", isNight: true },
            { label: "03:00-06:00", value: "3-6", isNight: true },
            { label: "06:00-12:00", value: "6-12", isNight: false },
            { label: "12:00-18:00", value: "12-18", isNight: false },
            { label: "18:00-24:00", value: "18-24", isNight: true },
        ];

        let currentScheduleData = [];

        function initControls() {
            const daysInput = document.getElementById('daysInput');
            const days = parseInt(daysInput.value) || 1;
            const startDaySelect = document.getElementById('startDayInput');
            const startTimeSelect = document.getElementById('startTimeInput');
            
            const prevDayValue = startDaySelect.value;
            startDaySelect.innerHTML = '';
            for(let i=1; i<=days; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `Day ${i}`;
                if(i == prevDayValue) opt.selected = true;
                startDaySelect.appendChild(opt);
            }

            if (startTimeSelect.innerHTML === '') {
                TIME_SLOTS.forEach((slot, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.textContent = slot.label;
                    if(index === 3) opt.selected = true;
                    startTimeSelect.appendChild(opt);
                });
            }
        }

        document.getElementById('daysInput').addEventListener('input', initControls);
        window.onload = initControls;

        function isSequential(res, id1, id2) {
            if (res.length === 0) return false;
            const lastEntry = res[res.length - 1];
            if (lastEntry.skipped) return false;
            const lastPlayers = lastEntry.players;
            if (!lastPlayers || lastPlayers.length === 0) return false;
            return lastPlayers.some(p => p.id === id1 || p.id === id2);
        }

        document.getElementById('generateBtn').onclick = function() {
            const days = parseInt(document.getElementById('daysInput').value) || 1;
            const startDay = parseInt(document.getElementById('startDayInput').value);
            const startTimeIdx = parseInt(document.getElementById('startTimeInput').value);
            const rawPeople = document.getElementById('peopleInput').value;
            
            const peopleList = rawPeople.split(/[,ï¼Œ\s]+/).map(s => s.trim()).filter(s => s);
            const males = ["19", "20", "21", "22", "23", "24", "25"]; 
            const nonEnglish = ["8", "9", "10", "11", "12", "13", "25"];
            const nonDrivers = ["2", "7", "8", "12", "13", "23", "24", "25"];
            const avoidWork = ["18"]; 

            const activePeople = peopleList
                .filter(id => !avoidWork.includes(id))
                .map(id => ({
                    id,
                    isMale: males.includes(id),
                    canEnglish: !nonEnglish.includes(id),
                    isDriver: !nonDrivers.includes(id),
                    needsEnglishPartner: ["5", "20", "23"].includes(id)
                }));

            currentScheduleData = [];
            let dailyHistory = {}; 

            for (let d = 1; d <= days; d++) {
                dailyHistory[d] = {};
                for (let tIdx = 0; tIdx < TIME_SLOTS.length; tIdx++) {
                    const slot = TIME_SLOTS[tIdx];
                    
                    if (d < startDay || (d === startDay && tIdx < startTimeIdx)) {
                        currentScheduleData.push({ day: d, slot, players: [], skipped: true });
                        continue;
                    }

                    let candidates = [];
                    for (let i = 0; i < activePeople.length; i++) {
                        for (let j = i + 1; j < activePeople.length; j++) {
                            const p1 = activePeople[i];
                            const p2 = activePeople[j];

                            let violations = 0;
                            if (isSequential(currentScheduleData, p1.id, p2.id)) violations += 100;
                            if ((dailyHistory[d][p1.id] || 0) >= 2) violations += 50;
                            if ((dailyHistory[d][p2.id] || 0) >= 2) violations += 50;
                            if (slot.isNight && !((p1.isMale && !p2.isMale) || (!p1.isMale && p2.isMale))) violations += 40;
                            if ((p1.needsEnglishPartner && !p2.canEnglish) || (p2.needsEnglishPartner && !p1.canEnglish)) violations += 30;

                            const isFirstDay = (d === 1);
                            const isLastDayLate = (d === days && slot.value === "18-24");
                            const hasDriver = p1.isDriver || p2.isDriver;
                            if (isFirstDay || isLastDayLate) {
                                if (hasDriver) violations += 25; 
                            } else if (["12-18", "18-24"].includes(slot.value) && !hasDriver) {
                                violations += 25; 
                            }

                            if ((p1.id === "10" || p2.id === "10") && tIdx < 3) violations += 20;
                            if ((p1.id === "24" || p2.id === "24") && d !== 4) violations += 20;
                            if ((p1.id === "2" || p2.id === "2") && slot.isNight) violations += 20;

                            const isEngAvoid = (d === 2 && slot.value === "18-24") || (d >= 3 && d <= 4 && ["12-18", "18-24"].includes(slot.value));
                            if (isEngAvoid && (p1.canEnglish || p2.canEnglish)) violations += 15;

                            candidates.push({ pair: [p1, p2], violations });
                        }
                    }

                    candidates.sort((a, b) => {
                        if (a.violations !== b.violations) return a.violations - b.violations;
                        const workloadA = (dailyHistory[d][a.pair[0].id] || 0) + (dailyHistory[d][a.pair[1].id] || 0);
                        const workloadB = (dailyHistory[d][b.pair[0].id] || 0) + (dailyHistory[d][b.pair[1].id] || 0);
                        return workloadA - workloadB;
                    });

                    const winner = candidates[0].pair;
                    const hadViolations = candidates[0].violations > 0;
                    
                    currentScheduleData.push({ 
                        day: d, 
                        slot, 
                        players: winner, 
                        skipped: false,
                        optimized: !hadViolations 
                    });

                    dailyHistory[d][winner[0].id] = (dailyHistory[d][winner[0].id] || 0) + 1;
                    dailyHistory[d][winner[1].id] = (dailyHistory[d][winner[1].id] || 0) + 1;
                }
            }
            renderSchedule(currentScheduleData, days);
            document.getElementById('exportBtn').classList.remove('hidden');
        };

        function renderSchedule(data, totalDays) {
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            container.className = 'lg:col-span-3 space-y-6';

            for (let d = 1; d <= totalDays; d++) {
                const dayData = data.filter(i => i.day === d);
                let dayHtml = `
                    <div class="card overflow-hidden border-slate-200 shadow-sm">
                        <div class="bg-slate-800 text-white px-6 py-4 flex items-center justify-center">
                            <h3 class="font-bold text-sm tracking-widest uppercase">Day ${d}</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-5 divide-y md:divide-y-0 md:divide-x divide-slate-100">
                `;

                dayData.forEach(item => {
                    dayHtml += `
                        <div class="p-5 slot-card ${item.skipped ? 'skipped' : ''}">
                            <div class="text-[10px] font-black text-slate-400 mb-4 border-b border-slate-50 pb-1 uppercase tracking-tighter">${item.slot.label}</div>
                            <div class="space-y-2">
                                ${item.players.length > 0 ? item.players.map(p => `
                                    <div class="px-3 py-2 rounded-xl text-xs font-bold flex justify-between items-center shadow-sm border ${!item.optimized ? 'bg-indigo-50/50 border-indigo-100 text-slate-700' : 'bg-white border-slate-100 text-slate-700'}">
                                        <div class="flex items-center gap-2">
                                            <span>${p.id}</span>
                                            ${p.isDriver ? '<span class="is-driver text-[10px] font-black" title="Driver">D</span>' : ''}
                                        </div>
                                        <span class="text-[10px] font-black ${p.isMale ? 'gender-m' : 'gender-f'}">
                                            ${p.isMale ? 'M' : 'F'}
                                        </span>
                                    </div>
                                `).join('') : '<div class="text-[10px] text-slate-300 italic py-2">--</div>'}
                            </div>
                        </div>
                    `;
                });

                dayHtml += `</div></div>`;
                container.innerHTML += dayHtml;
            }
        }

        document.getElementById('exportBtn').onclick = function() {
            if (currentScheduleData.length === 0) return;

            let textContent = "SHIFT SCHEDULE\n====================\n\n";
            let currentDay = -1;

            currentScheduleData.forEach(item => {
                if (item.skipped) return;
                
                if (item.day !== currentDay) {
                    currentDay = item.day;
                    textContent += `\n--- DAY ${currentDay} ---\n`;
                }

                const players = item.players.map(p => `${p.id}(${p.isMale?'M':'F'}${p.isDriver?'D':''})`).join(", ");
                textContent += `[${item.slot.label}] : ${players || "Unassigned"}\n`;
            });

            const blob = new Blob([textContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Schedule_Export_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        };
    </script>
</body>
</html>
