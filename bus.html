<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Master Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#F1F5F9]">
    <div id="root"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, deleteDoc, updateDoc, writeBatch, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      window.FB = { 
          initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
          getFirestore, doc, setDoc, collection, onSnapshot, addDoc, deleteDoc, updateDoc, writeBatch, query 
      };
      
      // Signal that Firebase is ready
      window.dispatchEvent(new Event('firebase-ready'));
  </script>

    <script type="text/babel">
        const Icon = ({ name, size = 16, className = "" }) => {
    useEffect(() => {
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }, [name]);

    return (
        <i 
            data-lucide={name} 
            className={className} 
            style={{ 
                width: size, 
                height: size, 
                display: 'inline-flex', 
                alignItems: 'center', 
                justifyContent: 'center' 
            }}
        ></i>
    );
};

        const firebaseConfig = {
            apiKey: "AIzaSyCLKH_gbj1AG1m0q4ilHwX8QH8LkZKIfbc",
            authDomain: "syscheduler.firebaseapp.com",
            projectId: "syscheduler",
            storageBucket: "syscheduler.firebasestorage.app",
            messagingSenderId: "6630964118",
            appId: "1:6630964118:web:97fdda60c8f240608b3bb7"
        };

        const appId = 'syscheduler-v4';
        const LOGIN_PASSWORD = "SY2026PERFORMANCE";
        const SHIFT_ORDER = ["0-3", "3-6", "6-12", "12-18", "18-24"];
        const SHIFT_DEFS = { "0-3": "00:00-03:00", "3-6": "03:00-06:00", "6-12": "06:00-12:00", "12-18": "12:00-18:00", "18-24": "18:00-00:00" };

        const INITIAL_ROSTER = [
          { num: 1, name: "Qing Wang", isMale: false, isEnglish: true, isDriver: true, hasCar: true },
          { num: 2, name: "Hao Wang (Diana)", isMale: false, isEnglish: true, isDriver: false, hasCar: false },
          { num: 3, name: "Ling Young", isMale: false, isEnglish: true, isDriver: true, hasCar: false },
          { num: 4, name: "Ma Lan (Sophia Li)", isMale: false, isEnglish: true, isDriver: true, hasCar: true },
          { num: 5, name: "Tham Nguyen (Mina)", isMale: false, isEnglish: true, isDriver: true, hasCar: false },
          { num: 6, name: "Qing Han", isMale: false, isEnglish: true, isDriver: true, hasCar: false },
          { num: 7, name: "Le Thi Oanh (Aria)", isMale: false, isEnglish: true, isDriver: false, hasCar: false },
          { num: 8, name: "Li Han", isMale: false, isEnglish: false, isDriver: false, hasCar: false },
          { num: 9, name: "Ping Jiang", isMale: false, isEnglish: false, isDriver: true, hasCar: false },
          { num: 10, name: "Hongjun Zheng (Lucinda)", isMale: false, isEnglish: false, isDriver: false, hasCar: false },
          { num: 11, name: "Dongxia Sun", isMale: false, isEnglish: false, isDriver: true, hasCar: false },
          { num: 12, name: "Xuemei Song (Sophie)", isMale: false, isEnglish: false, isDriver: false, hasCar: false },
          { num: 13, name: "Deyun Xia", isMale: false, isEnglish: false, isDriver: false, hasCar: false },
          { num: 14, name: "Lily Jia", isMale: false, isEnglish: true, isDriver: true, hasCar: true },
          { num: 15, name: "Tuyet Nhung (Adela)", isMale: false, isEnglish: true, isDriver: true, hasCar: false },
          { num: 16, name: "Thi Lien Huong (Lotus)", isMale: false, isEnglish: true, isDriver: true, hasCar: false },
          { num: 17, name: "Ling Wu (Cassie)", isMale: false, isEnglish: true, isDriver: true, hasCar: false },
          { num: 18, name: "Yongxian Li (Lynna)", isMale: false, isEnglish: true, isDriver: true, hasCar: true },
          { num: 19, name: "Xiaodong Xu (William)", isMale: true, isEnglish: true, isDriver: true, hasCar: true },
          { num: 20, name: "Larrison Manygoats", isMale: true, isEnglish: true, isDriver: true, hasCar: true },
          { num: 21, name: "Zhiyuan Xie (Harry)", isMale: true, isEnglish: true, isDriver: true, hasCar: true },
          { num: 22, name: "xiaoxiao", isMale: true, isEnglish: true, isDriver: false, hasCar: false },
          { num: 23, name: "Cong Nguyen (Charles)", isMale: true, isEnglish: true, isDriver: false, hasCar: false },
          { num: 24, name: "Jincheng Guo (Eric)", isMale: true, isEnglish: true, isDriver: false, hasCar: false },
          { num: 25, name: "Shunxiang Wu", isMale: true, isEnglish: false, isDriver: false, hasCar: false }
      ];

        // Initialize Firebase using the window object attached earlier
        const app = FB.initializeApp(firebaseConfig);
        const auth = FB.getAuth(app);
        const db = FB.getFirestore(app);

        const Badge = ({ p }) => (
            <div className="flex gap-1.5 mt-1.5 flex-wrap">
                <div className={`w-2 h-2 rounded-full ${p.isMale ? 'bg-blue-400' : 'bg-pink-400'}`}></div>
                {p.isEnglish && <div className="w-2 h-2 rounded-full bg-indigo-500"></div>}
                {p.isDriver && <div className="w-2 h-2 rounded-full bg-emerald-500"></div>}
                {p.hasCar && <div className="w-2 h-2 rounded-full bg-amber-400"></div>}
            </div>
        );

        function App() {
            const [isAuth, setIsAuth] = useState(false);
            const [passInput, setPassInput] = useState("");
            const [user, setUser] = useState(null);
            const [members, setMembers] = useState([]);
            const [secRules, setSecRules] = useState([]);
            const [schedule, setSchedule] = useState({ days: [] });
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingMember, setEditingMember] = useState(null);
            const [loading, setLoading] = useState(false);
            const [arrivalPeriod, setArrivalPeriod] = useState("12-18");
            
            const [dateRange, setDateRange] = useState({
                start: new Date().toISOString().split('T')[0],
                end: new Date(Date.now() + 86400000).toISOString().split('T')[0]
            });

            const [secForm, setSecForm] = useState({
                date: new Date().toISOString().split('T')[0],
                start: "08:00",
                end: "17:00"
            });

            useEffect(() => {
                const saved = localStorage.getItem(`auth_${appId}`);
                if (saved === LOGIN_PASSWORD) setIsAuth(true);
                FB.signInAnonymously(auth);
                return FB.onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user || !isAuth) return;
                const mRef = FB.collection(db, 'artifacts', appId, 'public', 'data', 'members');
                const rRef = FB.collection(db, 'artifacts', appId, 'public', 'data', 'secRules');
                const sRef = FB.doc(db, 'artifacts', appId, 'public', 'data', 'activeSchedule', 'current');

                const unsubM = FB.onSnapshot(mRef, (snap) => {
                    if (snap.empty) {
                        INITIAL_ROSTER.forEach(m => FB.addDoc(mRef, { ...m, inPool: true }));
                    } else {
                        setMembers(snap.docs.map(d => ({ ...d.data(), id: d.id })).sort((a, b) => a.num - b.num));
                    }
                });

                const unsubR = FB.onSnapshot(rRef, (snap) => {
                    setSecRules(snap.docs.map(d => ({ ...d.data(), id: d.id })));
                });

                const unsubS = FB.onSnapshot(sRef, (snap) => {
                    if (snap.exists()) setSchedule(snap.data());
                });

                return () => { unsubM(); unsubR(); unsubS(); };
            }, [user, isAuth]);

            const generateSchedule = async () => {
                const pool = members.filter(m => m.inPool);
                if (pool.length < 8) { alert("Need 8+ members in registry pool."); return; }
                
                setLoading(true);
                const start = new Date(dateRange.start + "T00:00:00");
                const end = new Date(dateRange.end + "T00:00:00");
                const generatedDays = [];
                
                let dIter = new Date(start);
                while (dIter <= end) {
                    const dateISO = dIter.toISOString().split('T')[0];
                    const dailyBusy = new Set();
                    const currentDay = {
                        id: crypto.randomUUID(),
                        date: dateISO,
                        label: dIter.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }),
                        security: [],
                        shifts: []
                    };

                    const dayRules = secRules.filter(r => r.date === dateISO);
                    dayRules.forEach(rule => {
                        const pPool = pool.filter(p => !dailyBusy.has(p.num) && p.isEnglish);
                        const p1 = pPool[Math.floor(Math.random() * pPool.length)] || pool[0];
                        dailyBusy.add(p1.num);
                        const p2 = pool.filter(p => !dailyBusy.has(p.num))[0];
                        dailyBusy.add(p2.num);
                        currentDay.security.push({ type: 'Primary', time: rule.time, players: [p1, p2] });
                    });

                    const isStartDay = dateISO === dateRange.start;
                    const startIndex = isStartDay ? SHIFT_ORDER.indexOf(arrivalPeriod) : 0;
                    
                    SHIFT_ORDER.slice(startIndex).forEach(key => {
                        const available = pool.filter(p => !dailyBusy.has(p.num));
                        let shiftPlayers = available.length >= 2 ? [available[0], available[1]] : [{ name: 'VACANT' }, { name: 'VACANT' }];
                        if (available.length >= 2) { dailyBusy.add(available[0].num); dailyBusy.add(available[1].num); }
                        currentDay.shifts.push({ time: SHIFT_DEFS[key], players: shiftPlayers });
                    });

                    generatedDays.push(currentDay);
                    dIter.setDate(dIter.getDate() + 1);
                }

                await FB.setDoc(FB.doc(db, 'artifacts', appId, 'public', 'data', 'activeSchedule', 'current'), {
                    days: generatedDays,
                    range: dateRange,
                    updatedAt: Date.now()
                });
                setLoading(false);
            };

            const handleSecuritySubmit = async (e) => {
                e.preventDefault();
                await FB.addDoc(FB.collection(db, 'artifacts', appId, 'public', 'data', 'secRules'), {
                    date: secForm.date,
                    time: `${secForm.start} - ${secForm.end}`
                });
            };

            const handleMemberSubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = {
                    num: Number(formData.get('num')),
                    name: formData.get('name'),
                    isMale: formData.get('gender') === 'male',
                    isEnglish: formData.get('eng') === 'on',
                    isDriver: formData.get('drv') === 'on',
                    hasCar: formData.get('car') === 'on',
                    inPool: true
                };
                if (editingMember) {
                    await FB.updateDoc(FB.doc(db, 'artifacts', appId, 'public', 'data', 'members', editingMember.id), data);
                    setEditingMember(null);
                } else {
                    await FB.addDoc(FB.collection(db, 'artifacts', appId, 'public', 'data', 'members'), data);
                }
                e.target.reset();
            };

            if (!isAuth) {
                return (
                    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md">
                          <Icon name="lock" size={40} className="mx-auto text-indigo-600 mb-6" />
                            <h1 className="text-center text-xl font-black uppercase tracking-widest mb-8">Access Portal</h1>
                            <form onSubmit={(e) => { e.preventDefault(); if (passInput === LOGIN_PASSWORD) { setIsAuth(true); localStorage.setItem(`auth_${appId}`, LOGIN_PASSWORD); }}} className="space-y-4">
                                <input type="password" value={passInput} onChange={(e) => setPassInput(e.target.value)} placeholder="Enter Pin" className="w-full bg-slate-100 p-4 rounded-2xl text-center font-bold outline-none ring-2 ring-transparent focus:ring-indigo-600" />
                                <button className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-xs">Unlock</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-[#F1F5F9] pb-20 text-slate-900">
                    <div className="max-w-7xl mx-auto p-4 lg:p-8">
                        <header className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm mb-8 flex flex-col md:flex-row items-center justify-between gap-6">
                            <div className="flex items-center gap-4">
                                <div className="bg-slate-900 p-3 rounded-2xl text-white"><Icon name="shield" size={20} /></div>
                                <div>
                                    <h1 className="text-xl font-black uppercase tracking-tighter">Shift Master <span className="text-indigo-600">Enterprise</span></h1>
                                    <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Version 4.0 // Single HTML</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setIsModalOpen(true)} className="bg-slate-100 px-5 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 hover:bg-slate-200 transition-colors">
                                  <Icon name="database" size={14} /> Registry
                                </button>
                                <button onClick={generateSchedule} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg flex items-center gap-2 hover:bg-indigo-700 transition-all">
                                    {loading ? <Icon name="rotate-cw" size={14} className="animate-spin" /> : <Icon name="refresh-ccw" size={14} />} Sync & Generate
                                </button>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <aside className="lg:col-span-3 space-y-6">
                                <div className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                                    <h3 className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-6 block">Scheduler Range</h3>
                                    <div className="space-y-4">
                                        <input type="date" value={dateRange.start} onChange={e => setDateRange({...dateRange, start: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border" />
                                        <input type="date" value={dateRange.end} onChange={e => setDateRange({...dateRange, end: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border" />
                                        <select value={arrivalPeriod} onChange={e => setArrivalPeriod(e.target.value)} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border">
                                            {SHIFT_ORDER.map(s => <option key={s} value={s}>{SHIFT_DEFS[s]}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                                    <h3 className="text-[10px] font-black uppercase tracking-widest text-indigo-600 mb-6 block">Add Security Job</h3>
                                    <form onSubmit={handleSecuritySubmit} className="space-y-4">
                                        <input type="date" value={secForm.date} onChange={e => setSecForm({...secForm, date: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl text-xs font-bold border" />
                                        <div className="grid grid-cols-2 gap-2">
                                            <input type="time" value={secForm.start} onChange={e => setSecForm({...secForm, start: e.target.value})} className="bg-slate-50 p-3 rounded-xl text-[10px] border" />
                                            <input type="time" value={secForm.end} onChange={e => setSecForm({...secForm, end: e.target.value})} className="bg-slate-50 p-3 rounded-xl text-[10px] border" />
                                        </div>
                                        <button className="w-full bg-slate-900 text-white py-3 rounded-xl text-[9px] font-black uppercase tracking-widest">Add Job</button>
                                    </form>
                                    <div className="mt-6 space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                                        {secRules.map(r => (
                                            <div key={r.id} className="bg-slate-50 p-2 rounded-lg flex justify-between items-center text-[9px] font-black border border-slate-100">
                                                <span>{r.date} â€¢ {r.time}</span>
                                                <button onClick={() => FB.deleteDoc(FB.doc(db, 'artifacts', appId, 'public', 'data', 'secRules', r.id))} className="text-rose-500"><Icon name="trash-2" size={12} /></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </aside>

                            <main className="lg:col-span-9 space-y-8">
                                {schedule.days.map((day) => (
                                    <div key={day.id} className="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden">
                                        <div className="bg-slate-900 px-8 py-5 flex justify-between items-center text-white">
                                            <h2 className="text-[11px] font-black uppercase tracking-widest">{day.label}</h2>
                                            <div className="w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)]"></div>
                                        </div>
                                        <div className="p-8 space-y-8">
                                            {day.security?.length > 0 && (
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-50 p-6 rounded-[1.5rem]">
                                                    {day.security.map((sec, idx) => (
                                                        <div key={idx} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                                                            <div className="flex justify-between items-center mb-3">
                                                                <span className="text-[9px] font-black text-indigo-600">{sec.time}</span>
                                                                <span className="text-[7px] font-black px-1.5 py-0.5 rounded bg-slate-900 text-white">{sec.type}</span>
                                                            </div>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                {sec.players.map((p, i) => <div key={i} className="bg-slate-50 p-2 rounded-lg text-[10px] font-bold border">{p.name} <Badge p={p}/></div>)}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
                                                {day.shifts.map((shift, idx) => (
                                                    <div key={idx} className="bg-slate-50 p-3 rounded-xl border">
                                                        <div className="flex items-center gap-1.5 mb-2 opacity-50 text-[8px] font-black uppercase"><Icon name="clock" size={10} /> {shift.time}</div>
                                                        {shift.players.map((p, i) => <div key={i} className="bg-white p-2 rounded-lg text-[9px] font-bold mb-1 shadow-sm">{p.name} <Badge p={p}/></div>)}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </main>
                        </div>
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] bg-slate-950/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-5xl h-[85vh] rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col">
                                <div className="bg-slate-900 p-6 text-white flex justify-between items-center">
                                    <h2 className="text-sm font-black uppercase tracking-widest flex items-center gap-2"><Icon name="database" size={14} /> Registry</h2>
                                    <button onClick={() => setIsModalOpen(false)} className="p-2 hover:bg-white/10 rounded-lg"><Icon name="x" size={20} /></button>
                                </div>
                                <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
                                    <div className="w-full md:w-80 p-6 bg-slate-50 border-r overflow-y-auto">
                                        <form onSubmit={handleMemberSubmit} className="space-y-4">
                                            <div className="grid grid-cols-3 gap-2">
                                                <input name="num" type="number" defaultValue={editingMember?.num} placeholder="#" className="p-3 rounded-xl border font-bold text-xs" required />
                                                <input name="name" type="text" defaultValue={editingMember?.name} placeholder="Name" className="col-span-2 p-3 rounded-xl border font-bold text-xs" required />
                                            </div>
                                            <select name="gender" defaultValue={editingMember?.isMale ? 'male' : 'female'} className="w-full p-3 rounded-xl border font-bold text-xs">
                                                <option value="female">Female</option>
                                                <option value="male">Male</option>
                                            </select>
                                            <div className="space-y-2 text-[10px] font-bold uppercase">
                                                <label className="flex justify-between p-3 bg-white border rounded-xl"><div className="flex items-center gap-2"><Icon name="languages" size={12} /> English</div> <input type="checkbox" name="eng" defaultChecked={editingMember?.isEnglish}/></label>
                                                <label className="flex justify-between p-3 bg-white border rounded-xl"><div className="flex items-center gap-2"><Icon name="car" size={12} /> License</div> <input type="checkbox" name="drv" defaultChecked={editingMember?.isDriver}/></label>
                                                <label className="flex justify-between p-3 bg-white border rounded-xl"><div className="flex items-center gap-2"><Icon name="user-check" size={12} /> Vehicle</div> <input type="checkbox" name="car" defaultChecked={editingMember?.hasCar}/></label>
                                            </div>
                                            <button className="w-full bg-indigo-600 text-white py-3 rounded-xl font-black text-[10px] uppercase">{editingMember ? 'Update' : 'Enroll'}</button>
                                        </form>
                                    </div>
                                    <div className="flex-1 p-6 overflow-y-auto">
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            {members.map(m => (
                                                <div key={m.id} className="p-3 rounded-xl bg-slate-50 border flex items-center justify-between group">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-8 h-8 rounded-lg bg-slate-900 text-white flex items-center justify-center text-[10px] font-black">{m.num}</div>
                                                        <div><p className="text-[10px] font-black text-slate-700">{m.name}</p><Badge p={m} /></div>
                                                    </div>
                                                    <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={() => setEditingMember(m)} className="p-1.5 text-indigo-500 hover:bg-white rounded"><Icon name="edit-2" size={12} /></button>
                                                        <button onClick={() => FB.deleteDoc(FB.doc(db, 'artifacts', appId, 'public', 'data', 'members', m.id))} className="p-1.5 text-rose-500 hover:bg-white rounded"><Icon name="trash-2" size={12} /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        window.addEventListener('firebase-ready', () => {
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
});
    </script>
</body>
</html>
