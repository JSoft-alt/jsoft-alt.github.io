<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Master MAX</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #F8FAFC; margin: 0; overflow-x: hidden; font-family: 'Inter', system-ui, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCLKH_gbj1AG1m0q4ilHwX8QH8LkZKIfbc",
            authDomain: "syscheduler.firebaseapp.com",
            projectId: "syscheduler",
            storageBucket: "syscheduler.firebasestorage.app",
            messagingSenderId: "6630964118",
            appId: "1:6630964118:web:97fdda60c8f240608b3bb7"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const APP_ID = 'syscheduler-v4';
        const PIN = "SY2026PERFORMANCE";
        const SHIFT_ORDER = ["0-3", "3-6", "6-12", "12-18", "18-24"];
        const SHIFT_DEFS = { "0-3": "00:00-03:00", "3-6": "03:00-06:00", "6-12": "06:00-12:00", "12-18": "12:00-18:00", "18-24": "18:00-00:00" };

        const Icon = ({ name, size = 16, className = "" }) => {
            const containerRef = useRef(null);
            
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({
                        attrs: { 
                            class: className, 
                            style: `width: ${size}px; height: ${size}px;` 
                        },
                        nameAttr: 'data-lucide',
                        root: containerRef.current
                    });
                }
            }, [name, className, size]);

            return (
                <span 
                    ref={containerRef} 
                    className="inline-flex items-center justify-center pointer-events-none"
                    style={{ width: size, height: size }}
                />
            );
        };

        const Badge = ({ p }) => {
            if (!p) return null;
            return (
                <div className="flex gap-1 mt-1.5 flex-wrap">
                    <div className={`w-2 h-2 rounded-full shadow-sm ${p.isMale ? 'bg-blue-400' : 'bg-pink-400'}`}></div>
                    {p.isEnglish && <div className="w-2 h-2 rounded-full shadow-sm bg-indigo-500"></div>}
                    {p.isDriver && <div className="w-2 h-2 rounded-full shadow-sm bg-emerald-500"></div>}
                    {p.hasCar && <div className="w-2 h-2 rounded-full shadow-sm bg-amber-400"></div>}
                </div>
            );
        };

        function App() {
            const [isAuth, setIsAuth] = useState(false);
            const [user, setUser] = useState(null);
            const [pinInput, setPinInput] = useState("");
            const [members, setMembers] = useState([]);
            const [secRules, setSecRules] = useState([]);
            const [schedule, setSchedule] = useState({ days: [] });
            const [isRegistryOpen, setIsRegistryOpen] = useState(false);
            const [regMode, setRegMode] = useState('view'); 
            const [editingMember, setEditingMember] = useState(null);
            const [loading, setLoading] = useState(false);

            const [dateRange, setDateRange] = useState({
                start: new Date().toISOString().split('T')[0],
                end: new Date(Date.now() + 86400000).toISOString().split('T')[0]
            });
            const [arrivalPeriod, setArrivalPeriod] = useState("12-18");
            const [secForm, setSecForm] = useState({ date: new Date().toISOString().split('T')[0], start: "08:00", end: "17:00" });

            useEffect(() => {
                if (localStorage.getItem('sy_v4_session') === PIN) setIsAuth(true);
                const unsubscribeAuth = auth.onAuthStateChanged((u) => {
                    if (u) setUser(u);
                    else auth.signInAnonymously().catch(console.error);
                });
                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const base = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
                const unsubM = base.collection('members').onSnapshot(s => setMembers(s.docs.map(d => ({...d.data(), id: d.id})).sort((a,b) => a.num - b.num)), err => console.error(err));
                const unsubR = base.collection('secRules').onSnapshot(s => setSecRules(s.docs.map(d => ({...d.data(), id: d.id}))), err => console.error(err));
                const unsubS = base.collection('activeSchedule').doc('current').onSnapshot(s => s.exists && setSchedule(s.data()), err => console.error(err));
                return () => { unsubM(); unsubR(); unsubS(); };
            }, [user]);

            const saveSchedule = async (newDays) => {
                if (!user) return;
                await db.collection('artifacts').doc(APP_ID).collection('public').doc('data')
                    .collection('activeSchedule').doc('current').set({ days: newDays, updatedAt: Date.now() });
            };

            const toggleMemberStatus = async (m) => {
                if (!user) return;
                try {
                    await db.collection('artifacts').doc(APP_ID).collection('public').doc('data')
                        .collection('members').doc(m.id).update({ inPool: !m.inPool });
                } catch (e) { console.error(e); }
            };

            const bulkTogglePool = async (status) => {
                if (!user) return;
                const batch = db.batch();
                members.forEach(m => {
                    const ref = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('members').doc(m.id);
                    batch.update(ref, { inPool: status });
                });
                await batch.commit();
            };

            const getRandomFromPool = (pool, excludeNums = []) => {
                const available = pool.filter(p => !excludeNums.includes(p.num));
                if (available.length === 0) return pool[Math.floor(Math.random() * pool.length)];
                return available[Math.floor(Math.random() * available.length)];
            };

            const generateSchedule = async () => {
                const pool = members.filter(m => m.inPool);
                if (pool.length < 5) { alert("Registry too small."); return; }
                
                setLoading(true);

                // Create a 2-second delay
                const delay = new Promise(resolve => setTimeout(resolve, 2000));

                const generatedDays = [];
                let dIter = new Date(dateRange.start + "T00:00:00");
                const dEnd = new Date(dateRange.end + "T00:00:00");

                while (dIter <= dEnd) {
                    const iso = dIter.toISOString().split('T')[0];
                    const dailyBusy = new Set();
                    const day = { id: crypto.randomUUID(), date: iso, label: dIter.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }), security: [], shifts: [] };

                    secRules.filter(r => r.date === iso).forEach(rule => {
                        const engPool = pool.filter(p => !dailyBusy.has(p.num) && p.isEnglish);
                        const p1 = engPool.length ? engPool[Math.floor(Math.random() * engPool.length)] : getRandomFromPool(pool, Array.from(dailyBusy));
                        dailyBusy.add(p1.num);
                        const p2 = getRandomFromPool(pool, Array.from(dailyBusy));
                        dailyBusy.add(p2.num);
                        day.security.push({ id: crypto.randomUUID(), time: rule.time, players: [p1, p2] });
                    });

                    const startIndex = (iso === dateRange.start) ? SHIFT_ORDER.indexOf(arrivalPeriod) : 0;
                    SHIFT_ORDER.slice(startIndex).forEach(key => {
                        const p1 = getRandomFromPool(pool, Array.from(dailyBusy)); dailyBusy.add(p1.num);
                        const p2 = getRandomFromPool(pool, Array.from(dailyBusy)); dailyBusy.add(p2.num);
                        day.shifts.push({ id: crypto.randomUUID(), time: SHIFT_DEFS[key], players: [p1, p2] });
                    });
                    generatedDays.push(day);
                    dIter.setDate(dIter.getDate() + 1);
                }

                // Wait for both the schedule generation and the 2-second delay to complete
                await Promise.all([saveSchedule(generatedDays), delay]);
                setLoading(false);
            };

            const rerollPerson = (dayId, sectionType, blockId, personIndex) => {
                const pool = members.filter(m => m.inPool);
                const newDays = JSON.parse(JSON.stringify(schedule.days));
                const day = newDays.find(d => d.id === dayId);
                const busy = new Set();
                day.security.forEach(s => s.players.forEach(p => busy.add(p.num)));
                day.shifts.forEach(s => s.players.forEach(p => busy.add(p.num)));
                const targetBlock = sectionType === 'security' ? day.security.find(s => s.id === blockId) : day.shifts.find(s => s.id === blockId);
                busy.delete(targetBlock.players[personIndex].num);
                targetBlock.players[personIndex] = getRandomFromPool(pool, Array.from(busy));
                saveSchedule(newDays);
            };

            const rerollBlock = (dayId, sectionType, blockId) => {
                const pool = members.filter(m => m.inPool);
                const newDays = JSON.parse(JSON.stringify(schedule.days));
                const day = newDays.find(d => d.id === dayId);
                const busy = new Set();
                day.security.forEach(s => s.id !== blockId && s.players.forEach(p => busy.add(p.num)));
                day.shifts.forEach(s => s.id !== blockId && s.players.forEach(p => busy.add(p.num)));
                const targetBlock = sectionType === 'security' ? day.security.find(s => s.id === blockId) : day.shifts.find(s => s.id === blockId);
                const p1 = getRandomFromPool(pool, Array.from(busy)); busy.add(p1.num);
                const p2 = getRandomFromPool(pool, Array.from(busy));
                targetBlock.players = [p1, p2];
                saveSchedule(newDays);
            };

            const addSecurityRule = () => {
                if (!user) return;
                const newTime = `${secForm.start}-${secForm.end}`;
                if (secRules.some(r => r.date === secForm.date && r.time === newTime)) return;
                db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('secRules').add({date: secForm.date, time: newTime});
            };

            const saveMember = async (e) => {
                e.preventDefault();
                if (!user) return;
                const fd = new FormData(e.target);
                const data = { num: Number(fd.get('num')), name: fd.get('name'), isMale: fd.get('gender') === 'male', isEnglish: fd.has('eng'), isDriver: fd.has('drv'), hasCar: fd.has('car'), inPool: true };
                const col = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('members');
                if (editingMember) await col.doc(editingMember.id).update(data);
                else await col.add(data);
                setEditingMember(null); setRegMode('view');
            };

            return (
                <div className="min-h-screen relative overflow-x-hidden">
                    {/* LOGIN VIEW */}
                    {!isAuth && (
                        <div className="min-h-screen flex items-center justify-center bg-slate-950 p-6 z-[300] fixed inset-0">
                            <div className="bg-white p-10 rounded-[3rem] w-full max-w-md text-center shadow-2xl">
                                <Icon name="lock" size={48} className="text-indigo-600 mb-6 mx-auto" />
                                <h2 className="text-2xl font-black uppercase mb-8 tracking-tight">Access Portal</h2>
                                <form onSubmit={(e) => {e.preventDefault(); if (pinInput === PIN) {setIsAuth(true); localStorage.setItem('sy_v4_session', PIN);}}} className="space-y-4">
                                    <input type="password" value={pinInput} onChange={e => setPinInput(e.target.value)} placeholder="••••" className="w-full bg-slate-100 p-6 rounded-3xl text-center text-3xl font-black outline-none focus:ring-4 ring-indigo-50 transition-all" />
                                    <button className="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black uppercase tracking-widest shadow-xl shadow-indigo-100 active:scale-95 transition-transform">Unlock</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* DASHBOARD VIEW */}
                    {isAuth && (
                        <div className="min-h-screen pb-20">
                            {!user && (
                                <div className="fixed inset-0 bg-white/80 z-[200] flex items-center justify-center">
                                    <div className="text-center">
                                        <Icon name="loader" size={40} className="animate-spin text-indigo-600 mx-auto mb-4" />
                                        <p className="font-black text-xs uppercase tracking-widest text-slate-500">Establishing Secure Link...</p>
                                    </div>
                                </div>
                            )}
                            <div className="max-w-[1400px] mx-auto p-4 lg:p-10">
                                <header className="bg-white p-7 rounded-[2.5rem] border shadow-sm mb-10 flex flex-col md:flex-row justify-between items-center gap-6">
                                    <div className="flex items-center gap-5">
                                        <div className="bg-slate-900 p-4 rounded-2xl text-white shadow-lg shadow-slate-200"><Icon name="shield" size={28} /></div>
                                        <div>
                                            <h1 className="text-2xl font-black uppercase tracking-tighter italic leading-none">Shift Master <span className="text-indigo-600">MAX</span></h1>
                                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mt-1.5">System Performance v4.0</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => setIsRegistryOpen(true)} className="bg-slate-50 border px-6 py-4 rounded-2xl font-black text-[11px] uppercase flex items-center gap-3 hover:bg-slate-100 transition-colors"><Icon name="users" size={16} /> Registry</button>
                                        <button onClick={generateSchedule} disabled={loading} className={`bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black text-[11px] uppercase flex items-center gap-3 shadow-xl shadow-indigo-100 active:scale-95 transition-all ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}>
                                            {loading ? <Icon name="refresh-cw" className="animate-spin" /> : <Icon name="refresh-cw" />} Reroll Full Range
                                        </button>
                                    </div>
                                </header>

                                <div className="grid grid-cols-1 lg:grid-cols-12 gap-10">
                                    <aside className="lg:col-span-3 space-y-8">
                                        <div className="bg-white p-7 rounded-[2.5rem] border shadow-sm">
                                            <h3 className="text-[11px] font-black uppercase text-slate-400 mb-6 tracking-widest flex items-center gap-2"><Icon name="settings" size={14}/> Range Settings</h3>
                                            <div className="space-y-4">
                                                <div className="space-y-1">
                                                    <label className="text-[9px] font-black uppercase text-slate-400 ml-2">Start Date</label>
                                                    <input type="date" value={dateRange.start} onChange={e => setDateRange({...dateRange, start: e.target.value})} className="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-xs outline-none focus:ring-2 ring-indigo-50" />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[9px] font-black uppercase text-slate-400 ml-2">End Date</label>
                                                    <input type="date" value={dateRange.end} onChange={e => setDateRange({...dateRange, end: e.target.value})} className="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-xs outline-none focus:ring-2 ring-indigo-50" />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[9px] font-black uppercase text-slate-400 ml-2">Arrival Period</label>
                                                    <select value={arrivalPeriod} onChange={e => setArrivalPeriod(e.target.value)} className="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-xs outline-none focus:ring-2 ring-indigo-50 appearance-none">
                                                        {SHIFT_ORDER.map(s => <option key={s} value={s}>{SHIFT_DEFS[s]}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-white p-7 rounded-[2.5rem] border shadow-sm">
                                            <h3 className="text-[11px] font-black uppercase text-indigo-600 mb-6 tracking-widest flex items-center gap-2"><Icon name="plus-circle" size={14}/> Add Security</h3>
                                            <div className="space-y-4">
                                                <input type="date" value={secForm.date} onChange={e => setSecForm({...secForm, date: e.target.value})} className="w-full p-4 bg-slate-50 border rounded-2xl text-xs outline-none font-bold" />
                                                <div className="grid grid-cols-2 gap-3">
                                                    <input type="time" value={secForm.start} onChange={e => setSecForm({...secForm, start: e.target.value})} className="p-3 border rounded-xl text-xs font-bold" />
                                                    <input type="time" value={secForm.end} onChange={e => setSecForm({...secForm, end: e.target.value})} className="p-3 border rounded-xl text-xs font-bold" />
                                                </div>
                                                <button onClick={addSecurityRule} className="w-full bg-slate-900 text-white py-4 rounded-2xl text-[10px] font-black uppercase shadow-lg active:scale-95 transition-transform">Add Rule</button>
                                            </div>
                                            <div className="mt-6 space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-1">
                                                {secRules.map(r => (
                                                    <div key={`secrule-item-${r.id}`} className="text-[9px] font-bold p-3 bg-slate-50 rounded-xl flex justify-between items-center border border-slate-100">
                                                        <span>{r.date} @ {r.time}</span>
                                                        <button onClick={() => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('secRules').doc(r.id).delete()} className="text-rose-500 hover:scale-110 transition-transform"><Icon name="trash" size={12}/></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="bg-white p-7 rounded-[2.5rem] border shadow-sm">
                                            <div className="flex justify-between items-center mb-6">
                                                <h3 className="text-[11px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2"><Icon name="user-check" size={14}/> Active Pool</h3>
                                                <div className="flex gap-2">
                                                    <button onClick={() => bulkTogglePool(true)} className="text-[8px] font-black text-indigo-600 uppercase hover:underline">All</button>
                                                    <button onClick={() => bulkTogglePool(false)} className="text-[8px] font-black text-rose-500 uppercase hover:underline">None</button>
                                                </div>
                                            </div>
                                            <div className="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar pr-1">
                                                {members.map(m => (
                                                    <div 
                                                        key={`pool-card-${m.id}`} 
                                                        onClick={() => toggleMemberStatus(m)}
                                                        className={`p-3 rounded-2xl border flex items-center justify-between cursor-pointer transition-all ${m.inPool ? 'bg-indigo-50 border-indigo-100 text-indigo-900 shadow-sm' : 'bg-white border-slate-100 opacity-40 grayscale'}`}
                                                    >
                                                        <div className="flex items-center gap-3 pointer-events-none">
                                                            <span className="w-5 h-5 rounded bg-slate-900 text-white text-[9px] font-black flex items-center justify-center">{m.num}</span>
                                                            <span className="text-[11px] font-bold truncate max-w-[100px]">{m.name}</span>
                                                        </div>
                                                        <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center transition-colors pointer-events-none ${m.inPool ? 'bg-indigo-600 border-indigo-600' : 'bg-transparent border-slate-200'}`}>
                                                            {m.inPool && <Icon name="check" size={10} className="text-white"/>}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </aside>

                                    <main className="lg:col-span-9 space-y-10">
                                        {schedule.days.map(day => (
                                            <div key={`day-card-${day.id}`} className="bg-white rounded-[3.5rem] border shadow-sm overflow-hidden">
                                                <div className="bg-slate-900 px-10 py-6 flex justify-between items-center text-white">
                                                    <div>
                                                        <h2 className="text-sm font-black uppercase tracking-[0.2em] italic">{day.label}</h2>
                                                        <p className="text-[9px] font-bold text-slate-500 mt-1 uppercase tracking-widest">{day.date}</p>
                                                    </div>
                                                </div>
                                                <div className="p-10 space-y-10">
                                                    {day.security?.length > 0 && (
                                                        <div className="space-y-4">
                                                            <h4 className="text-[10px] font-black text-indigo-500 uppercase tracking-widest ml-4">Security Personnel</h4>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-indigo-50/50 p-6 rounded-[2.5rem] border border-indigo-100">
                                                                {day.security.map((s) => (
                                                                    <div key={`sec-block-${s.id}`} className="bg-white p-4 rounded-3xl border shadow-sm relative group">
                                                                        <div className="flex justify-between items-center mb-3">
                                                                            <span className="text-[10px] font-black text-indigo-600 italic tracking-tight">{s.time}</span>
                                                                            <button onClick={() => rerollBlock(day.id, 'security', s.id)} className="opacity-0 group-hover:opacity-100 transition-opacity p-1.5 bg-slate-50 rounded-lg text-slate-400 hover:text-indigo-600"><Icon name="refresh-ccw" size={12}/></button>
                                                                        </div>
                                                                        <div className="grid grid-cols-2 gap-3">
                                                                            {s.players.map((p, j) => (
                                                                                <div key={`sec-player-${s.id}-${j}`} className="bg-slate-50 p-3 rounded-2xl text-[11px] font-bold border border-slate-100 flex flex-col relative group/p">
                                                                                    <span className="truncate pr-4">{p?.name || "Unassigned"}</span> 
                                                                                    <Badge p={p}/>
                                                                                    <button onClick={() => rerollPerson(day.id, 'security', s.id, j)} className="absolute top-2 right-2 opacity-0 group-p/p:opacity-100 p-1 text-slate-300 hover:text-indigo-500 transition-all"><Icon name="user-plus" size={12}/></button>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    <div className="space-y-4">
                                                        <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4">Standard Shifts</h4>
                                                        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                                                            {day.shifts.map((s) => (
                                                                <div key={`shift-block-${s.id}`} className="bg-slate-50 p-5 rounded-[2rem] border border-slate-100 flex flex-col group relative hover:border-indigo-200 transition-colors">
                                                                    <div className="flex justify-between items-center mb-4">
                                                                        <span className="text-[10px] font-black opacity-30 uppercase tracking-tighter italic">{s.time}</span>
                                                                        <button onClick={() => rerollBlock(day.id, 'shift', s.id)} className="opacity-0 group-hover:opacity-100 p-1.5 text-slate-400 hover:text-indigo-600 transition-all"><Icon name="refresh-cw" size={10}/></button>
                                                                    </div>
                                                                    {s.players.map((p, j) => (
                                                                        <div key={`shift-player-${s.id}-${j}`} className="bg-white p-3 rounded-2xl text-[10px] font-bold mb-2 shadow-sm border border-slate-100 relative group/p last:mb-0">
                                                                            <p className="truncate pr-3">{p?.name || "Unassigned"}</p> 
                                                                            <Badge p={p}/>
                                                                            <button onClick={() => rerollPerson(day.id, 'shift', s.id, j)} className="absolute top-2 right-2 opacity-0 group-p/p:opacity-100 p-1 text-slate-200 hover:text-indigo-500 transition-all"><Icon name="user-plus" size={10}/></button>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </main>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* REGISTRY MODAL */}
                    {isRegistryOpen && (
                        <div className="fixed inset-0 z-[400] bg-slate-950/90 backdrop-blur-md flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-6xl h-[90vh] rounded-[3.5rem] shadow-2xl overflow-hidden flex flex-col">
                                <div className="bg-slate-900 p-8 text-white flex justify-between items-center shrink-0">
                                    <div className="flex gap-6">
                                        <button onClick={() => setRegMode('view')} className={`text-sm font-black uppercase flex items-center gap-3 transition-colors ${regMode === 'view' ? 'text-indigo-400 underline underline-offset-8' : 'text-white hover:text-indigo-200'}`}><Icon name="users" /> Registry List</button>
                                        <button onClick={() => {setRegMode('add'); setEditingMember(null);}} className={`text-sm font-black uppercase flex items-center gap-3 transition-colors ${regMode === 'add' ? 'text-indigo-400 underline underline-offset-8' : 'text-white hover:text-indigo-200'}`}><Icon name="plus" /> Enrollment</button>
                                    </div>
                                    <button onClick={() => {setIsRegistryOpen(false); setRegMode('view'); setEditingMember(null);}} className="hover:rotate-90 transition-transform p-2 bg-white/10 rounded-full"><Icon name="x" size={24} /></button>
                                </div>

                                <div className="flex-1 overflow-y-auto custom-scrollbar bg-slate-50">
                                    {(regMode === 'add' || regMode === 'edit') ? (
                                        <div key={editingMember ? `edit-${editingMember.id}` : 'new-member'} className="w-full max-w-xl mx-auto py-12 px-6">
                                            <h2 className="text-2xl font-black uppercase mb-8 tracking-tight italic text-center">{regMode === 'add' ? 'New Enrollment' : 'Edit Profile'}</h2>
                                            <form onSubmit={saveMember} className="space-y-6 bg-white p-8 md:p-12 rounded-[3rem] shadow-xl border border-slate-100">
                                                <div className="grid grid-cols-4 gap-4">
                                                    <div className="col-span-1 space-y-1">
                                                        <label className="text-[9px] font-black uppercase text-slate-400 ml-1">#</label>
                                                        <input name="num" type="number" defaultValue={editingMember?.num} placeholder="No." className="w-full p-4 rounded-2xl border font-bold text-sm bg-slate-50 focus:ring-4 ring-indigo-50 outline-none transition-all" required />
                                                    </div>
                                                    <div className="col-span-3 space-y-1">
                                                        <label className="text-[9px] font-black uppercase text-slate-400 ml-1">Full Name</label>
                                                        <input name="name" type="text" defaultValue={editingMember?.name} placeholder="Enter name..." className="w-full p-4 rounded-2xl border font-bold text-sm bg-slate-50 focus:ring-4 ring-indigo-50 outline-none transition-all" required />
                                                    </div>
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[9px] font-black uppercase text-slate-400 ml-1">Gender Identification</label>
                                                    <select name="gender" defaultValue={editingMember?.isMale ? 'male' : 'female'} className="w-full p-4 rounded-2xl border font-bold text-sm bg-slate-50 outline-none appearance-none">
                                                        <option value="female">Female</option>
                                                        <option value="male">Male</option>
                                                    </select>
                                                </div>
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                                    {[
                                                        {k:'eng', l:'English', i:'languages'},
                                                        {k:'drv', l:'License', i:'user-check'},
                                                        {k:'car', l:'Vehicle', i:'car'}
                                                    ].map(({k,l,i}) => (
                                                        <label key={`check-group-${k}`} className="flex flex-col items-center justify-center p-6 bg-slate-50 border border-slate-100 rounded-[2.5rem] cursor-pointer hover:bg-white hover:shadow-md hover:border-indigo-100 transition-all group">
                                                            <div className={`p-3 rounded-xl bg-indigo-50 text-indigo-500 mb-3 group-hover:scale-110 transition-transform`}>
                                                                <Icon name={i} size={28} />
                                                            </div>
                                                            <span className="text-[10px] font-black uppercase mb-3 tracking-widest">{l}</span>
                                                            <input type="checkbox" name={k} defaultChecked={editingMember?.[k === 'eng' ? 'isEnglish' : k === 'drv' ? 'isDriver' : 'hasCar']} className="w-7 h-7 accent-indigo-600 rounded-lg cursor-pointer" />
                                                        </label>
                                                    ))}
                                                </div>
                                                <button className="w-full bg-indigo-600 text-white py-6 rounded-3xl font-black text-sm uppercase tracking-widest shadow-xl shadow-indigo-100 active:scale-95 transition-transform mt-4">
                                                    {regMode === 'add' ? 'Create Profile' : 'Apply Changes'}
                                                </button>
                                            </form>
                                        </div>
                                    ) : (
                                        <div className="p-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                            {members.map(m => (
                                                <div key={`reg-member-card-${m.id}`} className="p-6 rounded-[2rem] bg-white border border-slate-100 flex items-center justify-between group hover:border-indigo-500 transition-all shadow-sm hover:shadow-md">
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-12 h-12 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black text-sm shadow-lg shadow-slate-200">{m.num}</div>
                                                        <div className="overflow-hidden">
                                                            <p className="text-xs font-black truncate max-w-[120px]">{m.name}</p>
                                                            <Badge p={m}/>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => {setEditingMember(m); setRegMode('edit');}} className="p-2.5 text-indigo-500 hover:bg-indigo-50 rounded-xl transition-colors"><Icon name="edit-3" size={18} /></button>
                                                        <button onClick={() => {if(confirm(`Delete ${m.name}?`)) db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('members').doc(m.id).delete()}} className="p-2.5 text-rose-500 hover:bg-rose-50 rounded-xl transition-colors"><Icon name="trash" size={18} /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
